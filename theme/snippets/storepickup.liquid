{% comment %}
@name: Zapiet - Store Pickup + Delivery
@version: 4.1.0
@support: https://storepickup.zendesk.com/hc
@comments: DO NOT EDIT THIS FILE AS IT WILL BE OVERWRITTEN.
{% endcomment %}

{% comment %}
*** DEFAULT CONFIG ***
Do not change the following values. Please use the 
storepickup-addons.liquid file for custom configurations.
{% endcomment %}

{% assign disable_delivery = false %}
{% assign disable_pickups = false %}
{% assign disable_shipping = false %}

{% comment %}
Include FontAwesome for Icons.
{% endcomment %}
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">

{% assign checkout_methods = "shipping,pickup,delivery" | split: "," %}

{% for checkout_method in checkout_methods %}
  {% assign filter_enabled_key = checkout_method | append: '_filter_enabled' %}
  {% assign filter_enabled = shop.metafields.zapiet[filter_enabled_key] %}

  {% if filter_enabled == "1" %}
    {% assign filter_values_key = checkout_method | append: '_filter_value' %}
    {% assign filter_property_key = checkout_method | append: '_filter_property' %}
    {% assign filter_status_key = checkout_method | append: '_filter_status' %}

    {% assign filter_values = shop.metafields.zapiet[filter_values_key] | split: "," %}
    {% assign filter_property = shop.metafields.zapiet[filter_property_key] %}
    {% assign filter_status = shop.metafields.zapiet[filter_status_key] %}

    {% for filter_value in filter_values %}
      {% for item in cart.items %}
        {% for property in item.product[filter_property] %}
          {% if property == filter_value or property.title == filter_value %}
            {% case checkout_method %}
              {% when 'pickup' %}
                {% assign disable_pickups = shop.metafields.zapiet[filter_status_key] %}
              {% when 'delivery' %}
                {% assign disable_delivery = shop.metafields.zapiet[filter_status_key] %}
              {% when 'shipping' %}
                {% assign disable_shipping = shop.metafields.zapiet[filter_status_key] %}
            {% endcase %}
          {% endif %}
        {% endfor %}
      {% endfor %}
    {% endfor %}
  {% endif %}
{% endfor %}

{% include 'storepickup-addons' %}

{% comment %}
*** MULTIPLE LANGUAGES ***
If no language code is set default to English. 
If you have multiple languages on your store you 
can make this variable dynamic by using the 
storepickup-addons.liquid file.
{% endcomment %}

{% if language_code == blank %}
  {% if shop.metafields.zapiet.default_language == blank %}
    {% assign language_code = 'en' %}
  {% else %}
    {% assign language_code = shop.metafields.zapiet.default_language %}
  {% endif %}
{% endif %}

{% capture cache_identifier %}settings.{{ language_code }}{% endcapture %}

{{ 'storepickup.js' | asset_url | script_tag }}

<script type="text/javascript">
Zapiet.start({
    // Your myshopify.com domain name. 
    shop_identifier: '{{ shop.permanent_domain }}',
    // Which language would you like the widget in? Default English. 
    language_code: '{{ language_code }}',
    // Any custom settings can go here.
    settings: {
      disable_deliveries: {{ disable_delivery }},
      disable_pickups: {{ disable_pickups }},
      disable_shipping: {{ disable_shipping }}
    },
    customer: {
      first_name: '{{ customer.default_address.first_name }}',
      last_name: '{{ customer.default_address.last_name }}',
      company: '{{ customer.default_address.company }}',
      address1: '{{ customer.default_address.address1 }}',
      address2: '{{ customer.default_address.address2 }}',
      city: '{{ customer.default_address.city }}',
      province: '{{ customer.default_address.province }}',
      country: '{{ customer.default_address.country }}',
      zip: '{{ customer.default_address.zip }}',
      phone: '{{ customer.default_address.phone }}'
    },
    advance_notice: {
      pickup: {
        value: '{{ pickup_notice_value }}',
        unit: '{{ pickup_notice_unit }}',
        breakpoint: '{{ pickup_notice_breakpoint }}',
        after_breakpoint_value: '{{ pickup_notice_after_breakpoint_value }}',
        after_breakpoint_unit: '{{ pickup_notice_after_breakpoint_unit }}'
      },
      delivery: { 
        value: '{{ delivery_notice_value }}',
        unit: '{{ delivery_notice_unit }}',
        breakpoint: '{{ delivery_notice_breakpoint }}',
        after_breakpoint_value: '{{ delivery_notice_after_breakpoint_value }}',
        after_breakpoint_unit: '{{ delivery_notice_after_breakpoint_unit }}'
      },
      shipping: {
        value: '{{ shipping_notice_value }}',
        breakpoint: '{{ shipping_notice_breakpoint }}',
        after_breakpoint_value: '{{ shipping_notice_after_breakpoint_value }}'
      }
    },
    // Do not modify the following parameters.
    cached_config: {{ shop.metafields.zapiet[cache_identifier] }}
});
</script>